<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlickFinder PRO | Rewarded Edition</title>
    
    <!-- üí∞ Monetag SDK & Rewarded Script -->
    <script src='//libtl.com/sdk.js' data-zone='10509475' data-sdk='show_10509475'></script>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .active-tab { background-color: #ef4444 !important; }
        .movie-card:active { transform: scale(0.96); }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <header class="glass sticky top-0 z-50 p-4 flex justify-between items-center shadow-xl">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center font-black italic shadow-lg">F</div>
            <h1 class="font-bold text-sm tracking-tighter uppercase">FLICK PRO</h1>
        </div>
        <select id="mediaType" onchange="loadContent('/trending')" class="bg-gray-800 text-[10px] font-bold p-2 rounded-xl outline-none border border-gray-700 text-white">
            <option value="movie">üé• MOVIES</option>
            <option value="tv">üì∫ SERIES</option>
        </select>
    </header>

    <!-- Filters Section -->
    <section class="p-4 space-y-4">
        <input type="text" id="searchInput" placeholder="Search movies, actors, years..." 
               class="w-full bg-gray-800/50 border border-gray-700 rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-red-500">
        
        <div class="flex gap-2 overflow-x-auto hide-scroll text-[10px] font-bold uppercase">
            <button onclick="loadContent('/trending')" class="bg-red-600 px-5 py-2.5 rounded-xl whitespace-nowrap">Trending üî•</button>
            
            <select onchange="loadContent('/discover?genre=' + this.value)" class="bg-gray-800 px-3 py-2 rounded-xl border border-gray-700 outline-none">
                <option value="genres">üìÅ Genres</option>
                <option value="28">Action</option>
                <option value="35">Comedy</option>
                <option value="27">Horror</option>
                <option value="10749">Romance</option>
                <option value="878">Sci-Fi</option>
            </select>

            <select onchange="loadContent('/discover?rating=' + this.value)" class="bg-gray-800 px-3 py-2 rounded-xl border border-gray-700 outline-none">
                <option value="rating">‚≠ê Rating</option>
                <option value="9">‚≠ê 9+</option>
                <option value="8">‚≠ê 8+</option>
                <option value="7">‚≠ê 7+</option>
                <option value="6">‚≠ê 6+</option>
            </select>

            <button onclick="const y=prompt('Year:'); if(y) loadContent('/discover?year='+y)" class="bg-gray-800 px-5 py-2.5 rounded-xl whitespace-nowrap">Year üóìÔ∏è</button>
        </div>
    </section>

    <!-- Grid -->
    <main id="grid" class="grid grid-cols-2 gap-4 px-4 min-h-[40vh]"></main>

    <!-- Modal Detail -->
    <div id="movieModal" class="fixed inset-0 bg-black/98 z-[60] hidden overflow-y-auto p-4 pt-16">
        <button onclick="closeModal()" class="fixed top-6 left-6 w-10 h-10 bg-red-600 rounded-full text-white text-2xl z-[70]">&times;</button>
        <div id="modalBody" class="space-y-6 pb-10 text-left"></div>
    </div>

    <!-- Navigation -->
    <nav class="fixed bottom-0 inset-x-0 glass p-4 flex justify-around items-center z-50 bg-gray-950/95 rounded-t-[30px]">
        <button onclick="loadContent('/trending')" class="flex flex-col items-center gap-1 text-red-500">
            <span class="text-xl">üè†</span><span class="text-[9px] font-black uppercase">Explore</span>
        </button>
        <button onclick="openWatchlist()" class="flex flex-col items-center gap-1 text-gray-500">
            <span class="text-xl">‚≠ê</span><span class="text-[9px] font-black uppercase">Watchlist</span>
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const API_URL = "https://yssef.pythonanywhere.com";
        const MONETAG_SMARTLINK = "https://otieu.com/4/10509481";

        async function loadContent(endpoint) {
            const grid = document.getElementById('grid');
            const type = document.getElementById('mediaType').value;
            grid.innerHTML = "<p class='col-span-2 text-center py-20 opacity-50 text-xs font-black uppercase tracking-widest'>Loading...</p>";

            try {
                const sep = endpoint.includes('?') ? '&' : '?';
                const url = `${API_URL}${endpoint}${sep}type=${type}`;
                const res = await fetch(url);
                const data = await res.json();
                renderGrid(data);
            } catch (e) { grid.innerHTML = "<p class='text-red-500 text-center col-span-2 uppercase font-bold'>Connection Failed</p>"; }
        }

        function renderGrid(data) {
            const grid = document.getElementById('grid');
            if(!data || data.length === 0) { grid.innerHTML = "<p class='col-span-2 text-center opacity-50 py-20 uppercase text-xs'>No results</p>"; return; }
            grid.innerHTML = data.map(m => `
                <div class="movie-card bg-gray-800/30 rounded-[24px] overflow-hidden border border-white/5 shadow-xl" onclick='showMovieDetails(${JSON.stringify(m).replace(/'/g, "&apos;")})'>
                    <img src="https://image.tmdb.org/t/p/w500${m.poster_path}" class="w-full h-56 object-cover" loading="lazy">
                    <div class="p-3 text-[10px] font-bold truncate uppercase tracking-tight text-gray-200">${m.title || m.name}</div>
                </div>
            `).join('');
        }

        function showMovieDetails(movie) {
            const modal = document.getElementById('movieModal');
            const body = document.getElementById('modalBody');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            body.innerHTML = `
                <div class="relative w-full h-[45vh] rounded-[32px] overflow-hidden shadow-2xl">
                    <img src="https://image.tmdb.org/t/p/w780${movie.backdrop_path || movie.poster_path}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                    <h2 class="absolute bottom-4 px-6 text-2xl font-black uppercase italic">${movie.title || movie.name}</h2>
                </div>
                <div class="px-2 space-y-4">
                    <div class="flex gap-2 text-[10px] font-black uppercase">
                        <span class="bg-red-600 px-3 py-1.5 rounded-lg italic text-white tracking-widest">‚≠ê ${movie.vote_average?.toFixed(1) || 'N/A'}</span>
                        <span class="bg-gray-800 px-3 py-1.5 rounded-lg text-gray-400 font-bold tracking-widest">${(movie.release_date || movie.first_air_date || "").substring(0,4)}</span>
                    </div>
                    <p class="text-[13px] text-gray-400 leading-relaxed font-medium">${movie.overview || "No plot summary available."}</p>
                    <div class="flex flex-col gap-3 pt-4">
                        <button onclick="playTrailer(${movie.id})" class="w-full bg-white text-black py-5 rounded-2xl font-black text-sm uppercase italic shadow-2xl active:scale-95 transition-all">üé¨ Unlock Trailer</button>
                        <button onclick='addToWatchlist(${JSON.stringify(movie).replace(/'/g, "&apos;")})' class="w-full bg-gray-800 text-gray-300 py-5 rounded-2xl font-bold text-xs uppercase active:scale-95 transition-all">‚ûï Add to Watchlist</button>
                    </div>
                </div>
            `;
        }

        // --- üèÜ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑÿ¨ÿØŸäÿØ ---
        function playTrailer(id) {
            // 1. ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑÿ®ŸäŸÜŸä (Rewarded Interstitial)
            show_10509475().then(async () => {
                // 2. ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ∞Ÿä ÿ≥ŸäŸÜŸÅÿ∞ ÿ®ŸÄÿπÿØ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ
                tg.HapticFeedback.impactOccurred('medium');
                const type = document.getElementById('mediaType').value;
                const res = await fetch(`${API_URL}/trailer?id=${id}&type=${type}`);
                const data = await res.json();
                
                tg.showPopup({
                    title: 'Trailer Unlocked!',
                    message: 'Thank you for supporting us. You can now watch the trailer.',
                    buttons: [
                        {id:'ad', text:'üöÄ High Speed (Sponsor)'}, 
                        {id:'yt', text:'‚ñ∂Ô∏è YouTube Direct'}
                    ]
                }, (btn) => {
                    if(btn === 'ad') tg.openLink(MONETAG_SMARTLINK);
                    else if(btn === 'yt') tg.openLink(data.link || "https://youtube.com");
                });
            }).catch(e => {
                // ŸÅŸä ÿ≠ÿßŸÑ ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿå ŸÜÿ≥ŸÖÿ≠ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ© ÿ£Ÿäÿ∂ÿßŸã ŸÑŸÉŸä ŸÑÿß Ÿäÿ™ÿπÿ∑ŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                console.log("Ad skipped or failed");
                tg.showAlert("Something went wrong with the ad, but we'll show you the trailer anyway!");
                // ŸÉŸàÿØ ÿ¨ŸÑÿ® ÿßŸÑÿ™ÿ±ŸäŸÑÿ± ÿßŸÑÿπÿßÿØŸä ŸÉÿÆÿ∑ÿ© ÿ®ÿØŸäŸÑÿ© (Fallback)
            });
        }

        function addToWatchlist(m) {
            let list = JSON.parse(localStorage.getItem('wl') || '[]');
            if(!list.find(x => x.id === m.id)) { list.push(m); localStorage.setItem('wl', JSON.stringify(list)); }
            tg.showAlert("Added to Watchlist!");
        }

        function openWatchlist() { renderGrid(JSON.parse(localStorage.getItem('wl') || '[]')); }
        function closeModal() { document.getElementById('movieModal').classList.add('hidden'); document.body.style.overflow = 'auto'; }

        // ÿßŸÑÿ®ÿ≠ÿ´
        let timer;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(timer);
            timer = setTimeout(async () => {
                const q = e.target.value;
                if(q.length > 2) {
                    const res = await fetch(`${API_URL}/search?q=${encodeURIComponent(q)}`);
                    const data = await res.json();
                    renderGrid(data);
                } else if(q.length === 0) loadContent('/trending');
            }, 500);
        });

        loadContent('/trending');
    </script>
</body>
</html>
