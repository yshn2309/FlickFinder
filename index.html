<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlickFinder PRO | Ultimate Movie App</title>

<!-- Monetag SDK -->
<script src='//libtl.com/sdk.js' data-zone='10509475' data-sdk='show_10509475'></script>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  background:#0f172a;
  color:white;
  font-family:'Inter',sans-serif;
  user-select:none;
}
.glass {
  background:rgba(30,41,59,.75);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(255,255,255,.1);
}
.movie-card { transition:.3s; cursor:pointer }
.movie-card:active { transform:scale(.96) }
.hide-scroll::-webkit-scrollbar { display:none }
.tab-active { background:#ef4444;font-weight:bold }
.skeleton {
  background:linear-gradient(90deg,#1e293b 25%,#334155 50%,#1e293b 75%);
  background-size:200% 100%;
  animation:shimmer 1.5s infinite;
  border-radius:8px
}
@keyframes shimmer {
  0%{background-position:-200% 0}
  100%{background-position:200% 0}
}
</style>
</head>

<body class="pb-24">

<header class="glass sticky top-0 z-50 p-4 flex justify-between items-center">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center">
      <span class="font-bold italic">F</span>
    </div>
    <h1 class="font-bold uppercase">FlickFinder <span class="text-red-500 text-xs">PRO</span></h1>
  </div>
  <div id="username" class="text-xs text-gray-400"></div>
</header>

<section class="p-4">
  <input id="searchInput" placeholder="Search movies..."
    class="w-full bg-gray-800/60 border border-gray-700 rounded-xl p-3 text-sm outline-none">
</section>

<main id="movieGrid" class="grid grid-cols-2 gap-4 px-4 min-h-[50vh]"></main>

<nav class="fixed bottom-0 inset-x-0 glass p-3 flex justify-around z-50">
  <button onclick="loadTrending()" class="text-red-500">üè†</button>
  <button onclick="tg.showAlert('Coming soon')">‚≠ê</button>
</nav>

<!-- Modal -->
<div id="movieModal" class="fixed inset-0 bg-black/95 hidden z-50 p-4 overflow-y-auto">
  <button onclick="closeModal()" class="text-red-500 text-3xl">√ó</button>
  <div id="modalBody" class="mt-4"></div>
</div>

<script>
/* ================= CONFIG ================= */
const tg = window.Telegram.WebApp;
tg.expand();

const API_URL = "https://yssef.pythonanywhere.com";
const MONETAG_LINK = "https://otieu.com/4/10509481";

/* ================= USER ================= */
document.getElementById("username").innerText =
  tg.initDataUnsafe?.user?.first_name || "PRO User";

/* ================= HELPERS ================= */
const sanitize = t => {
  const d=document.createElement("div");
  d.textContent=t||"";
  return d.innerHTML;
};

/* ================= FETCH ================= */
async function fetchMovies(endpoint){
  const grid=document.getElementById("movieGrid");
  grid.innerHTML=Array(6).fill(`
    <div class="skeleton h-56"></div>
  `).join("");

  try{
    const url = `${API_URL}${endpoint}${endpoint.includes("?")?"&":"?"}t=${Date.now()}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Server error");
    const data = await res.json();
    const movies = data.results || [];

    if(!movies.length){
      grid.innerHTML="<p class='col-span-2 text-center text-gray-400'>No results</p>";
      return;
    }

    grid.innerHTML = movies.map(m=>{
      const poster = m.poster_path
        ? `https://image.tmdb.org/t/p/w500${m.poster_path}`
        : "https://via.placeholder.com/300x450";
      return `
        <div class="movie-card bg-gray-800 rounded-xl overflow-hidden"
          onclick='showDetails(${JSON.stringify(m).replace(/"/g,"&quot;")})'>
          <img src="${poster}" class="h-56 w-full object-cover">
          <div class="p-2 text-xs">
            <b>${sanitize(m.title||m.name)}</b>
          </div>
        </div>`;
    }).join("");

  }catch(e){
    grid.innerHTML="<p class='col-span-2 text-center text-red-500'>Connection error</p>";
  }
}

/* ================= ROUTES ================= */
function loadTrending(){
  fetchMovies("/trending");
}

/* ================= SEARCH ================= */
let timer;
document.getElementById("searchInput").addEventListener("input",e=>{
  clearTimeout(timer);
  const q=e.target.value.trim();
  if(q.length>2){
    timer=setTimeout(()=>fetchMovies(`/search?query=${encodeURIComponent(q)}`),500);
  }else if(!q){
    loadTrending();
  }
});

/* ================= MODAL ================= */
function showDetails(movie){
  document.getElementById("movieModal").classList.remove("hidden");
  document.getElementById("modalBody").innerHTML=`
    <h2 class="text-xl font-bold">${sanitize(movie.title||movie.name)}</h2>
    <p class="text-sm text-gray-400">${sanitize(movie.overview)}</p>
    <button onclick="tg.openLink('${MONETAG_LINK}')"
      class="mt-4 bg-red-600 px-4 py-2 rounded">WATCH HD</button>`;
}
function closeModal(){
  document.getElementById("movieModal").classList.add("hidden");
}

/* ================= INIT ================= */
fetch(`${API_URL}/health`)
  .then(r=>r.json())
  .then(()=>loadTrending())
  .catch(()=>alert("Backend not reachable"));
</script>

</body>
</html>
